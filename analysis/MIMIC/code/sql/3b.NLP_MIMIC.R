#setwd("~/Documents/Bioinformatics/Classes/FALL/HST.953/Git_Files_Cardiogenic/953-2019-team_i/analysis/MIMIC")

#Loading of libraries

source("./code/library_load.R")
source("./code/sql/sql_access.R")

# Notes loading
notes_query <- "WITH NOTES AS
(
SELECT
notes.hadm_id, notes.charttime, notes.subject_id, ie.intime, notes.text, ie.first_careunit, notes.category
FROM `physionet-data.mimiciii_notes.noteevents` AS notes
LEFT JOIN  `physionet-data.mimiciii_clinical.icustays` AS ie
ON notes.hadm_id = ie.hadm_id
)
SELECT *
FROM NOTES 
WHERE DATETIME_DIFF (CHARTTIME, intime, DAY) < 1.01 
AND
subject_id in
(
SELECT subject_id
FROM (
    SELECT subject_id, hadm_id, intime, outtime, los, ROW_NUMBER() OVER(PARTITION BY hadm_id ORDER BY intime) rn
    FROM `physionet-data.mimiciii_clinical.icustays`
    WHERE first_careunit = 'CCU'
    ) 
x
WHERE rn = 1
)"

discharge_summary_query1 <- "WITH NOTES AS
(
SELECT
notes.hadm_id, notes.charttime, notes.subject_id, notes.text, ie.first_careunit, notes.category
FROM `physionet-data.mimiciii_notes.noteevents` AS notes
LEFT JOIN  `physionet-data.mimiciii_clinical.icustays` AS ie
ON notes.hadm_id = ie.hadm_id
)
SELECT *
FROM NOTES 
WHERE notes.category = 'Discharge summary'
AND
subject_id in
(13,21,25,38,55,62,94,146,151,163,177,199,205,222,228,234,270,275,308,318,320,328,346,354,379,391,426,439,445,456,462,472,491,495,515,539,554,557,589,608,
619,638,653,698,702,710,731,738,745,749,792,805,806,813,816,824,837,840,859,924,931,960,969,975,1017,1020,1021,1026,1028,1037,1041,1044,1049,1050,1069,
1097,1113,1114,1197,1216,1217,1227,1244,1264,1266,1308,1317,1329,1354,1367,1369,1385,1395,1396,1417,1458,1459,1501,1555,1556,1574,1586,1604,1627,1647,
1649,1658,1676,1696,1734,1746,1754,1763,1767,1777,1782,1802,1816,1818,1855,1866,1924,1937,1949,1979,1982,1991,1999,2025,2035,2047,2052,2063,2071,2115,
2213,2219,2223,2224,2229,2231,2237,2253,2259,2326,2346,2356,2366,2370,2415,2427,2446,2455,2481,2488,2590,2592,2598,2610,2614,2639,2641,2649,2714,2784,
2788,2790,2799,2836,2841,2858,2889,2917,2930,2944,2946,2961,2964,2975,2990,3007,3011,3024,3078,3097,3137,3171,3182,3183,3199,3235,3252,3267,3295,3297,3324,
3365,3369,3404,3426,3433,3439,3481,3496,3521,3564,3566,3593,3616,3652,3674,3680,3683,3686,3735,3744,3745,
3775,3793,3794,3800,3834,3838,3853,3877,3883,3914,3973,3974,3980,4032,4041,4053,4073,4100,4147,4236,4240,4273,4316,4323,4324,4329,4331,4362,4369,4374,4401,
4406,4420,4422,4453,4465,4477,4533,4568,4575,4587,4590,4609,4641,4655,4685,4712,4719,4745,4766,4777,4799,4802,4807,4843,4847,4857,4859,4861,4874,4875,4893,
4906,4956,4985,5030,5039,5047,5071,5126,5145,5168,5205,5238,5239,5252,5259,5265,5277,5330,5336,5362,5365,5369,5370,5386,5452,5454,5476,5478,5481,5527,5535,
5551,5555,5573,5599,5619,5620,5626,5738,5783,5789,5832,5880,5901,5910,5913,5951,5955,5964,5982,6012,6053,6070,6082,6086,6092,6129,6189,6196,6204,6215,6222,
6244,6283,6292,6312,6338,6349,6353,6362,6375,6421,6425,6455,6474,6534,6539,6542,6548,6561,6628,6632,6673,6685,6692,6694,6696,6712,6759,6774,6800,6802,6804,
6821,6832,6835,6841,6845,6873,6914,6920,6942,6950,6953,6955,6958,6976,6979,6990,6996,7013,7037,7062,7065,7066,7118,7156,7163,7183,7184,7225,7234,7251,7258,
7262,7334,7355,7427,7429,7445,7452,7460,7478,7490,7515,7537,7554,7569,7605,7612,7615,7616,7638,7650,7651,7654,7666,7695,7696,7709,7710,7761,7769,7790,7804,
7828,7839,7849,7860,7881,7911,7952,7953,7997,8050,8057,8073,8105,8109,8115,8120,8131,8138,8142,8186,8188,8193,8224,8238,8264,8309,8314,8338,8358,8368,8389,
8396,8426,8444,8479,8486,8516,8533,8547,8551,8571,8586,8608,8668,8686,8691,8705,8754,8780,8789,8803,8819,8844,8870,8889,8890,8899,8920,8921,8924,8942,8943,
8948,8969,8983,8990,9021,9030,9032,9034,9043,9097,9132,9133,9139,9158,9163,9178,9186,9200,9204,9233,9247,9251,9258,9263,9284,9303,9311,9324,9325,9330,9335,
9336,9341,9358,9369,9384,9424,9444,9461,9473,9555,9567,9584,9602,9620,9642,9664,9672,9677,9688,9691,9708,9714,9744,9753,9801,9811,9821,9877,9887,9893,9901,
9906,9920,9965,9976,9992,10049,10061,10068,10152,10160,10170,10206,10278,10294,10302,10360,10373,10384,10467,10500,10501,10506,10569,10604,10607,10616,10624,
10644,10669,10676,10677,10715,10746,10753,10763,10811,10820,10822,10861,10906,10933,10973,10981,10999,11013,11026,11035,11055,11061,11063,11066,11095,11097,
11107,11108,11114,11122,11137,11147,11161,11184,11202,11204,11205,11218,11244,11265,11289,11312,11416,11424,11431,11438,11507,11566,11575,11616,11617,11618,
11624,11633,11664,11672,11712,11723,11728,11770,11787,11809,11840,11863,11892,11901,11908,11918,11920,11952,11957,11971,12008,12038,12058,12081,12099,12125,
12188,12203,12210,12248,12274,12310,12322,12346,12357,12403,12413,12442,12543,12553,12573,12586,12643,12646,12648,12694,12706,12711,12725,12726,12744,12769,
12781,12796,12807,12821,12830,12838,12856,12878,12920,12928,12952,12961,13029,13038,13039,13055,13078,13123,13151,13183,13201,13244,13259,13309,13319,13377,
13420,13437,13441,13501,13502,13541,13599,13625,13715,13719,13723,13767,13772,13793,13796,13806,13807,13812,13813,13857,13866,13884,13947,13956,13970,13978,
14008,14024,14054,14084,14098,14102,14104,14123,14131,14156,14159,14160,14202,14210,14266,14312,14323,14328,14332,14337,14342,14345,14346,14379,14381,14431,
14432,14448,14456,14458,14467,14472,14476,14480,14484,14495,14506,14511,14517,14520,14522,14529,14539,14578,14584,14590,14593,14600,14606,14711,14743,14744,
14747,14772,14777,14780,14822,14825,14857,14858,14860,14922,14936,14965,14967,14994,14995,15017,15052,15057,15079,15119,15120,15135,15147,15149,15166,15185,
15227,15230,15247,15254,15279,15294,15311,15315,15353,15365,15376,15398,15409,15421,15439,15450,15465,15472,15480,15484,15504,15546,15548,15558,15563,15610,
15632,15664,15671,15685,15687,15691,15718,15745,15759,15763,15782,15842,15850,15867,15898,15902,15904,15911,15943,15972,15997,16007,16055,16066,16076,16078,
16084,16112,16122,16172,16193,16194,16210,16232,16261,16296,16332,16404,16459,16463,16490,16525,16550,16558,16560,16588,16616,16618,16636,16651,16653,16662,
16738,16748,16752,16839,16840,16847,16848,16856,16888,16932,16961,16965,16992,17002,17012,17028,17055,17069,17072,17078,17108,17122,17123,17135,17144,17162,
17191,17234,17241,17244,17269,17318,17339,17355,17370,17472,17506,17512,17539,17546,17551,17556,17558,17574,17652,17659,17675,17688,17720,17722,17786,17819,
17827,17828,17932,18037,18059,18071,18084,18088,18100,18139,18155,18159,18200,18223,18264,18274,18293,18315,18358,18413,18426,18452,18477,18485,18531,18559,
18583,18584,18598,18619,18625,18629,18630,18638,18642,18648,18676,18687,18740,18764,18779,18815,18866,18893,18942,18983,19012,19038,19055,19071,19108,19126,
19223,19233,19267,19282,19325,19326,19345,19370,19424,19440,19444,19450,19472,19483,19513,19603,19617,19654,19716,19734,19755,19764,19811,19891,19912,19983,
19998,20000,20010,20013,20024,20062,20072,20086,20091,20116,20124,20129,20154,20190,20194,20207,20218,20283,20303,20326,20330,20338,20353,20355,20449,20479,
20501,20542,20592,20639,20664,20704,20747,20766,20791,20794,20795,20804,20813,20884,20898,20900,20903,20906,20922,20931,20940,20943,20965,20966,20977,21002,
21042,21051,21086,21097,21108,21115,21180,21193,21220,21234,21237,21247,21265,21267,21270,21271,21279,21280,21306,21324,21325,21383,21402,21419,21431,21440,
21444,21454,21481,21483,21517,21533,21547,21568,21569,21584,21625,21630,21638,21660,21663,21681,21710,21730,21738,21752,21784,21792,21795,21857,21870,21880,
21901,21920,21922,21945,21949,21951,21967,21975,22010,22019,22024,22028,22080,22138,22143,22148,22157,22163,22177,22186,22207,22218,22248,22278,22289,22336,
22354,22364,22383,22412,22431,22437,22449,22464,22466,22498,22499,22512,22516,22530,22544,22557,22560,22626,22651,22659,22665,22673,22686,22697,22715,22732,
22735,22752,22766,22777,22804,22811,22861,22883,22918,22924,22956,22966,22973,23008,23020,23028,23038,23039,23048,23060,23082,23108,23118,23120,23121,23124,
23154,23161,23164,23173,23201,23210,23258,23282,23292,23308,23325,23368,23405,23434,23470,23474,23478,23481,23483,23487,23490,23497,23523,23550,23560,23568,
23580,23581,23582,23626,23641,23650,23677,23682,23696,23701,23711,23714,23735,23749,23780,23808,23821,23840,23851,23872,23884,23928,23984,23990,24004,24008,
24042,24085,24125,24127,24129,24141,24238,24244,24307,24326,24379,24439,24446,24450,24457,24475,24477,24504,24514,24547,24571,24591,24623,24643,24675,24694,
24740,24750,24792,24793,24820,24824,24865,24876,24892,24922,24942,24949,24950,24958,24979,24988,24990,25001,25008,25029,25044,25046,25063,25069,25084,25116,
25124,25152,25157,25158,25163,25167,25171,25179,25197,25214,25222,25235,25256,25286,25368,25436,25505,25506,25516,25523,25559,25618,25621,25658,25690,25717,
25720,25728,25741,25742,25775,25779,25806,25812,25837,25838,25841,25858,25870,25882,25901,25928,25940,25997,26000,26013,26026,26031,26079,26099,26107,26160,
26195,26219,26277,26300,26370,26380,26396,26398,26418,26446,26459,26469,26472,26502,26504,26516,26519,26550,26589,26597,26632,26637,26638,26678,26679,26690,
26704,26710,26818,26844,26849,26856,26868,26883,26887,26936,26977,26978,27002,27013,27054,27089,27108,27148,27155,27174,27177,27184,27202,27212,27220,27223,
27232,27235,27237,27266,27351,27382,27390,27418,27442,27447,27454,27464,27469,27481,27486,27492,27512,27554,27560,27607,27644,27691,27723,27742,27744,27850,
27900,27944,27957,27962,28012,28029,28063,28083,28109,28111,28128,28137,28155,28164,28165,28168,28199,28217,28219,28268,28281,28337,28354,28364,28409,28412,
28414,28416,28440,28455,28464,28505,28564,28583,28587,28588,28625,28629,28660,28683,28698,28702,28707,28789,28808,28863,28875,28927,28930,28932,28951,28968,
28974,29034,29086,29111,29170,29179,29183,29186,29199,29203,29215,29224,29231,29256,29263,29270,29280,29299,29333,29335,29336,29343,29357,29453,29468,29486,
29493,29509,29531,29573,29597,29652,29663,29690,29712,29727,29769,29779,29780,29805,29826,29872,29887,29905,29906,29920,29946,29954,30047,30071,30075,30088,
30094,30122,30135,30143,30156,30200,30222,30224,30240,30260,30286,30290,30349,30376,30409,30413,30425,30428,30433,30469,30477,30510,30534,30542,30591,30637,
30685,30689,30785,30815,30828,30851,30919,30956,31005,31029,31052,31111,31112,31131,31140,31153,31183,31237,31239,31251,31319,31330,31331,31342,31439,31454,
31462,31470,31502,31503,31509,31515,31585,31625,31662,31692,31721,31797,31798,31808,31813,31866,31958,31985,31989,32039,32050,32064,32083,32098,32136,32169,
32184,32219,32268,32288,32361,32373,32380,32389,32434,32504,32550,32574,32663,32705,32739,32763,32788,32790,32793,32805,40057,40120,40161,40287,40310,40337,
40461,40503,40586,40601,40672,40691,40897,41163,41209,41217,41255,41517,41588,41693,41710,41758,41929,41966,41976,42075,42326,42438,42525,42682,42685,42694,
42771,42781,42794,42815,42937,42995,43220,43459,43564,43584,43735,43837,43948,44019,44082,44255,44328,44437,44459,44539,44685,44951,44958,44973,45057,45127,
45342,45601,45657,45684,45761,45994,45995,46041,46123,46154,46188,46254,46257,46268,46380,46441,46498,46548,46608,46642,46793,46820,46836,46884,46911,46927,
47335,47365,47445,47546,47547,47643,47715,47733,48005,48143,48257,48391,48498,48697,48857,48882,48958,49067,49079,49082,49202,49446,49485,49520,49611,49613,
50087,50161,50221,50303,50337,50362,50409,50417,50528,50636,50692,50859,51006,51079,51203,51222,51301,51337)"


discharge_summary_query2 <- "WITH NOTES AS
(
SELECT
notes.hadm_id, notes.charttime, notes.subject_id, notes.text, ie.first_careunit, notes.category
FROM `physionet-data.mimiciii_notes.noteevents` AS notes
LEFT JOIN  `physionet-data.mimiciii_clinical.icustays` AS ie
ON notes.hadm_id = ie.hadm_id
)
SELECT *
FROM NOTES 
WHERE notes.category = 'Discharge summary'
AND
subject_id in
(51384,51545,51557,51676,51682,51683,51813,52000,52065,52205,52260,52269,52302,52420,52620,52641,52746,52816,52899,53014,53036,53176,53252,53342,53347,53355,53372,53425,53435,53594,53608,53758,53804,53865,53868,54020,54043,54183,54209,54241,54260,54473,54616,54636,54648,54675,54681,54736,54825,54900,54994,55001,55083,55122,55201,55209,55407,55503,55588,55688,55725,55751,55849,55920,55925,55935,56091,56112,56243,56364,56375,56459,56589,56772,56796,57091,57187,57190,57306,57321,57369,57569,57654,57774,57982,58027,58049,58098,58135,58218,58229,58312,58456,58484,58580,58586,58649,58757,58963,59049,59085,59198,59199,59201,59215,59268,59343,59442,59489,59546,59547,59701,59822,59855,59937,60179,60262,60353,60403,60614,60897,60920,60970,61030,61076,61081,61163,61194,61282,61447,61458,61463,61605,61619,61630,61835,62238,62456,62608,62646,62926,63003,63012,63041,63109,63145,63272,63298,63325,63525,63733,63762,63938,63952,64087,64153,64230,64314,64334,64352,64450,64798,65256,65270,65404,65696,65848,65959,66014,66221,66714,66958,67058,67172,67344,67347,67365,67377,67680,67925,68065,68115,68299,68391,68409,68439,68543,68623,68753,68780,68916,68956,69011,69024,69219,69243,69579,69857,70119,70125,70188,70433,70500,70745,71139,71219,71579,71702,71764,71797,72000,72270,72280,72282,72357,72402,72528,72644,72999,73134,73175,73303,73310,73370,73713,73742,73837,73902,73955,73967,73993,74181,74211,74223,74419,74493,74523,74768,74913,74932,74955,74976,75023,75039,75051,75053,75061,75134,75170,75223,75371,75393,75420,75435,75503,75668,75715,75856,76035,76193,76196,76222,76327,76454,76479,76514,76529,76658,76715,76857,76861,76930,76975,76988,76994,77101,77135,77203,77301,77395,77439,77676,77826,77947,77951,77980,78100,78273,78336,78366,78447,78658,78814,78864,79075,79094,79126,79300,79310,79425,79466,79602,79677,79878,79900,79905,80120,80134,80142,80345,80423,80436,80539,80653,80744,80752,80843,80844,80891,81318,81371,81434,81478,81491,81567,81577,81581,81692,81754,81791,81883,81893,82065,82079,82111,82119,82122,82132,82221,82290,82609,82843,82868,82904,83128,83225,83338,83532,83565,83640,83653,83671,83697,83962,83981,83991,84388,84410,84601,84749,84891,85002,85245,85291,85407,85489,85598,85723,85866,85971,86078,86123,86144,86206,86315,86326,86331,86585,86590,86773,86786,86842,86913,86915,86934,87082,87206,87275,87344,87347,87549,87646,87818,87959,88258,88286,88458,88569,88594,88636,88809,88852,88909,89161,89297,89448,89697,89758,89768,89956,89984,90026,90143,90289,90325,90396,90403,90418,90450,90479,90495,90686,90776,91221,91242,91248,91258,91343,91529,91549,91579,91635,91802,91858,91913,91995,92227,92292,92316,92518,92613,92651,92799,92843,92957,93021,93387,93388,93391,93602,93659,93662,93701,93966,94195,94202,94220,94300,94581,94696,94782,94785,94911,95155,95282,95339,95372,95561,95706,95707,95957,95986,95991,96083,96108,96305,96356,96378,96424,96427,96533,96592,96718,96879,96928,96975,97217,97333,97351,97547,97565,97593,9760997637,97890,98118,98268,98336,98359,98390,98413,98514,98687,98714,98720,98815,98834,98973,99064,99065,99102,99120,99298,99442,99469,99472,99483,99528,99714,99901,99982)
"


discharge_summary_ccu1 <- run_query(discharge_summary_query1) #all discharge summaries of ccu patients
discharge_summary_ccu2 <- run_query(discharge_summary_query2) #all discharge summaries of ccu patients
discharge_summary <- bind_rows(discharge_summary_ccu1, discharge_summary_ccu2)

notes_ccu <- run_query(notes_query) 

# Loading cardiogenic shock

shock_m <- read_csv("./data/mimic_cardiogenic_shock_id.csv")
#paste(shock_m$subject_id, sep="", collapse = "," )

# First 24 hour notes filtration ------------------------------------------



# Cardiogenic shock table for filtration
# We used a the subject_id from the final MIMIC cardiogenic shock cohort
# Contained in file : file="mimic_cardiogenic_shock_id.csv")

# Only keep notes of patient in shock
notes_ccu <- notes_ccu%>%select("subject_id","text", "category")
notes_ccu2 <- shock_m%>% #the shock_m table is table from another project that only contains the subject id of the cardiogenic shock cohort
  left_join(notes_ccu, by=c("subject_id"="subject_id"))
#notes_ccu3 <- notes_ccu2%>%filter(category!='Radiology') # Removing all radiology notes as less accurate for information on cardiac arrest
#strategy cancelled because reduced the number of patients

finalnotes <- notes_ccu2

length(unique(finalnotes$subject_id)) # This allows to verify that there is a note for each single cardiogenic shock patient 


# Discharge Summary notes filtration --------------------------------------

#Only keeping notes from patients in shock
#discharge_ccu <- discharge_summary_ccu%>%select("subject_id","text", "category")
#discharge_ccu <- shock_m%>% #the shock_m table is table from another project that only contains the subject id of the cardiogenic shock cohort
  #left_join(discharge_ccu, by=c("subject_id"="subject_id"))

#length(unique(discharge_ccu$subject_id)) # This allows to verify that there is a note for each single cardiogenic shock patient 

#discharge_ccu2 <- discharge_ccu%>%filter((str_detect(text, regex("discharge",ignore_case = TRUE))
                                                    #==TRUE))


# NLP Regex ---------------------------------------------------------------

#testing <- finalnotes[1:100,] # Test dataset to evaluate the NLP framework

# Function that verifies if evidence of cardiac arrest
extract_arrest<- function(text)
{
  arrestregex <- regex("therapeutic hypothermia|return of spontaneous circulation|\\brosc\\b|cardiac arrest|defilbrillated|\\bcpr\\b|[1-3][0-9][0][J]|vfib|ventricular fibrillation", ignore_case = TRUE) 
  #vfib not added because higher risk of antecedent diagnosis
  match <- str_detect(text, arrestregex)
  return(as.numeric(match))
}

# This function adds 1 in the column arrest if the regex is found to be positive in the corresponding document
finding_arrest <- function(df)
{
  mutate(df, arrest = 0)
  df$arrest <- sapply(df[,"text"], FUN = extract_arrest)
  return(df)
}

# Testing

#testing2 <- finding_arrest(testing)
#head(testing2)
#write.csv(testing2, file="testingnotesnlp.csv")

# Group dataframe with a final condition : if a positive cardiac arrest in >= 1 note, then final diagnostic = cardiac arrest

finalnotes_arrest <- finding_arrest(finalnotes) # Adding column for each note

finalnotes_arrest2 <- finalnotes_arrest%>%group_by(subject_id, arrest)%>% # Grouping patient individually bi subject_id
  summarise()

table(finalnotes_arrest2$arrest)


# Testing accuracy --------------------------------------------------------

finalnotes_arrest_positive <- finalnotes_arrest%>%filter(arrest==1)
write.csv(finalnotes_arrest_positive, file="testingnotesnlp.csv")

# 2 methods for assessing
# First : compare to discharge summary
# Second : looking at notes of patient

